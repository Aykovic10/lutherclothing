<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LUTHER - Orders</title>

  <!-- Light mode favicons (use -b / black logos) -->
  <link rel="icon" type="image/png" href="assets/icons/favicon-b.png" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32-b.png" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16-b.png" media="(prefers-color-scheme: light)">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon-b.png" media="(prefers-color-scheme: light)">

  <!-- Dark mode favicons (use normal / white logos) -->
  <link rel="icon" type="image/png" href="assets/icons/favicon.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png" media="(prefers-color-scheme: dark)">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" media="(prefers-color-scheme: dark)">

  <!-- Self-hosted display font -->
  <link rel="preload" href="assets/fonts/futura-heavy.otf" as="font" type="font/otf" crossorigin>

  <style>
    body { background-color: #FAF9F6; }

    @font-face {
      font-family: 'LutherHeavy';
      src: url('assets/fonts/futura-heavy.otf') format('opentype');
      font-weight: 900;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --text: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --bg: #FAF9F6;
      --ink: #111;
      --muted: #666;
      --heroTex: url('https://uploads.onecompiler.io/43vn54brk/43vn542r9/black_texture_1920x1080.png');
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--text); }
    body, html { height: 100%; overflow-x: hidden; }

    /* Header */
    header{
      position: fixed; top: 0; width: 100%; height: 50px;
      padding: 0 40px; display: flex; justify-content: center; align-items: center;
      z-index: 1001; background-color: transparent; transition: background-color .3s ease;
    }
    .nav-links{ position:absolute; right:40px; display:flex; gap:16px; }
    header a{
      text-decoration:none; color:white; font-weight:300; text-transform:uppercase;
      font-size:.8rem; position:relative; letter-spacing:.06em;
    }
    .logo-center{ height: 40px; transition: opacity .3s ease; cursor: pointer; }

    /* Mobile menu */
    .mobile-menu {
      display: none; position: fixed; top: 50px; left: 0; width: 100%; height: calc(100% - 50px);
      background: rgba(255,255,255,0.05) var(--heroTex) no-repeat center center / cover;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      flex-direction: column; justify-content: center; align-items: center; gap: 30px; z-index: 1000;
      opacity: 0; visibility: hidden; transform: translateY(-100%);
      transition: opacity .4s, transform .4s, visibility .4s;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
    }
    .mobile-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .mobile-menu a{
      color:white; text-decoration:none; font-size: 1.1rem; text-transform: uppercase; font-weight: 300;
      padding: 10px; letter-spacing: .08em; transition: all .3s ease;
      text-shadow: 0 0 5px rgba(0,0,0,.3);
    }

    /* Hamburger */
    .hamburger{
      display:none; flex-direction:column; justify-content:center;
      width:30px; height:25px; cursor:pointer; position:absolute; right:20px; gap:4px; z-index:1002;
    }
    .hamburger span{ background:white; height:1px; width:100%; transition: all .3s ease; }
    .hamburger span:nth-child(3){ display:none; }
    body.menu-open { overflow: hidden; }

    @media (max-width: 768px){
      header{ padding:0 20px; }
      .nav-links{ display:none; }
      .hamburger{ display:flex; }
      .logo-center{ position:absolute; left:50%; transform:translateX(-50%); height:30px; z-index:1002; }
    }

    /* Hero */
    .hero{
      background: var(--heroTex) no-repeat center center/cover;
      height: 55vh; min-height: 380px;
      position: relative;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      color:white; text-align:center;
    }
    .hero h1{
      font-family:'LutherHeavy', var(--text);
      font-weight:900;
      font-size: clamp(2rem, 4vw + 1rem, 3.2rem);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .hero p{
      margin-top: 10px;
      font-size: 1rem;
      font-weight: 300;
      font-family: 'Courier New', Courier, monospace;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity: .92;
    }

    /* Section heading */
    .section-heading{ text-align:center; margin: 24px 0 16px; }
    .section-title{
      font-family:'LutherHeavy', var(--text);
      font-weight:900;
      text-transform:uppercase;
      text-align:center;
      letter-spacing:.12em;
      color: var(--ink);
      font-size: clamp(1.3rem, 2.5vw + .5rem, 2.2rem);
      margin: 0 0 6px;
      line-height:1.05;
      padding: 0 16px;
    }
    .section-subtitle{
      font-size: .85rem;
      font-weight: 300;
      color: #555;
      letter-spacing: .05em;
      text-transform: uppercase;
      margin-top: 2px;
      padding: 0 16px;
    }

    /* Page content */
    main{ background: var(--bg); padding: 0; }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 0 16px 60px; }

    /* Cards */
    .card{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 10px;
      background: #FAF9F6;
      padding: 16px;
    }

    .card h3{
      font-family: 'LutherHeavy', var(--text);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: .95rem;
      color: var(--ink);
      margin-bottom: 12px;
    }

    .muted{ color: #777; font-size: .75rem; text-transform: uppercase; letter-spacing: .1em; font-weight: 300; }

    /* Form */
    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

    label{
      display:block;
      font-size: .7rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: .12em;
      margin-bottom: 6px;
      font-weight: 300;
    }

    input, textarea{
      width:100%;
      padding: 12px 12px;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      background: transparent;
      color: var(--ink);
      outline: none;
      font-size: .9rem;
    }
    textarea{ min-height: 110px; resize: vertical; }

    .row{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    .btn{
      padding: 12px 18px;
      font-size: .85rem;
      font-weight: 500;
      border: 1px solid var(--ink);
      border-radius: 5px;
      background-color: rgba(0,0,0,.02);
      color: var(--ink);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .btn.primary{
      background: rgba(255,255,255,.05) var(--heroTex) no-repeat center/cover;
      color: white;
      border: 1px solid rgba(255,255,255,0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .btn:disabled{ opacity: .6; cursor:not-allowed; }

    /* PRODUCTS: image-select tiles + size buttons */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width: 900px) {
      .products-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    .product-tile {
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      overflow: hidden;
      background: #FAF9F6;
    }

    .product-tile .img {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      overflow: hidden;
      cursor: pointer;
    }
    .product-tile .img img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .25s ease, filter .25s ease;
    }
    .product-tile .img:hover img { transform: scale(1.03); }

    .product-tile .label {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 10px;
      border-radius: 10px;
      background: rgba(250,249,246,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .product-tile .label .name {
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #111;
      font-weight: 600;
      line-height: 1.2;
    }
    .product-tile .label .state {
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: #111;
      font-weight: 300;
      opacity: .8;
    }

    .product-tile.selected {
      outline: 1px solid rgba(0,0,0,0.5);
      outline-offset: 2px;
    }
    .product-tile.selected .img img { filter: contrast(1.05); }

    /* Products area actions */

.btn.small {
  padding: 10px 14px;
  font-size: .75rem;
  letter-spacing: .10em;
}


    .size-wrap { padding: 12px; }
    .size-row { display: flex; flex-wrap: wrap; gap: 8px; }

    .size-btn {
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      background: transparent;
      color: #111;
      font-size: .75rem;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: .10em;
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .05s ease;
    }
    .size-btn {
  position: relative;
}

/* little count bubble */
.size-btn .count {
  display: none;
  margin-left: 8px;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.35);
  font-size: .7rem;
  letter-spacing: .02em;
  font-weight: 500;
}

.size-btn.active .count {
  display: inline-block;
}

    .size-btn:active { transform: scale(0.98); }

    .size-btn.active {
      background: rgba(0,0,0,0.06);
      border-color: rgba(0,0,0,0.55);
      font-weight: 500;
    }

    .size-hint {
      margin-top: 10px;
      font-size: .65rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: #777;
      font-weight: 300;
    }

    /* Analytics */
    .kpi{ display:flex; gap: 16px; flex-wrap: wrap; padding: 10px 0 6px; }
    .kpi .box{ border: 1px solid rgba(0,0,0,0.12); border-radius: 10px; padding: 12px 14px; min-width: 160px; }
    .kpi .val{ font-family:'LutherHeavy', var(--text); font-weight: 900; font-size: 1.4rem; color: var(--ink); letter-spacing: .04em; }
    .kpi .lab{ margin-top: 6px; font-size: .7rem; text-transform: uppercase; letter-spacing: .12em; color:#666; font-weight: 300; }

    .table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius: 10px; border: 1px solid rgba(0,0,0,0.10); }
    .table th, .table td{ padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.08); text-align:left; font-size: .85rem; }
    .table th{ font-size: .7rem; text-transform: uppercase; letter-spacing: .12em; color:#555; font-weight: 300; background: rgba(0,0,0,0.02); }

    footer{
      text-align:center; padding: 40px 20px;
      font-size:.75rem; font-weight:300;
      text-transform:uppercase; color:#999;
      background: var(--bg);
      letter-spacing: .08em;
    }
  </style>
</head>

<body>
  <header id="header" style="background-color: transparent; backdrop-filter: none;">
    <a href="#" id="leftLink" style="position:absolute; left:20px; color:white; font-size:.8rem; font-weight:300; text-transform:uppercase; text-decoration:none; letter-spacing:.06em;">Back</a>
    <img id="headerLogo" class="logo-center" style="height: 20px; max-height: 20px;" src="assets/logos/lutherTextWhite.png" alt="Luther Logo">
    <div class="nav-links">
      <a href="#" id="ordersBtn">Orders</a>
      <a href="#" id="analyticsBtn">Analytics</a>
    </div>
    <div class="hamburger" id="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="mobileMenu">
      <span></span><span></span><span></span>
    </div>
  </header>

  <nav class="mobile-menu" id="mobileMenu">
    <a href="#" id="mobileOrdersBtn">Orders</a>
    <a href="#" id="mobileAnalyticsBtn">Analytics</a>
  </nav>

  <section class="hero" id="hero">
    <h1>Orders Console</h1>
    <p>Internal order capture + sheet sync</p>
  </section>

  <main>
    <div class="wrap">
      <div class="section-heading">
        <h2 class="section-title">Create Order</h2>
        <p class="section-subtitle">Select products, pick sizes, save to your sheet</p>
      </div>

      <section class="card" id="ordersSection">
        <h3>Order Details</h3>

        <div class="grid">
          <div>
            <label>First Name</label>
            <input id="firstName" autocomplete="given-name" />
          </div>
          <div>
            <label>Last Name</label>
            <input id="lastName" autocomplete="family-name" />
          </div>
          <div>
            <label>Instagram Handle</label>
            <input id="instagram" placeholder="@..." />
          </div>
          <div>
            <label>Email Address</label>
            <input id="email" type="email" autocomplete="email" />
          </div>
          <div>
            <label>Phone Number</label>
            <input id="phone" type="tel" autocomplete="tel" />
          </div>
          <div>
            <label>Notes</label>
            <textarea id="notes"></textarea>
          </div>
        </div>

        <div style="margin-top:14px;"
  <h3 style="margin-bottom:10px;">Products</h3>

  <div class="products-grid" id="products"></div>

  

  <p class="muted" style="margin-top:10px;">Select one or more sizes under a product.</p>
</div>


        <div class="row" style="margin-top:14px;">
  <button class="btn primary" id="submitBtn">Save Order</button>
  <button class="btn" id="clearProductsBtn" type="button">Clear</button>
  <span class="muted" id="status"></span>
</div>

        <div style="margin-top:18px;">
  <h3 style="margin-top: 6px;">Orders</h3>
  <table class="table" id="ordersTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Items</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p class="muted" style="margin-top:10px;" id="ordersListStatus"></p>
</div>

      </section>

      <div class="section-heading" style="margin-top: 28px;">
        <h2 class="section-title">Analytics</h2>
        <p class="section-subtitle">Totals + breakdowns pulled from your sheet</p>
      </div>

      <section class="card" id="analyticsSection">
        <h3>Overview</h3>

        <div class="kpi">
          <div class="box">
            <div class="val" id="totalOrders">0</div>
            <div class="lab">Total Orders</div>
          </div>
          <div class="box">
            <div class="val" id="totalItems">0</div>
            <div class="lab">Total Items</div>
          </div>
        </div>

        <div class="grid" style="margin-top: 10px;">
          <div>
            <h3 style="margin-top: 6px;">By Product</h3>
            <table class="table" id="productTable">
              <thead><tr><th>Product</th><th>Count</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3 style="margin-top: 6px;">By Size</h3>
            <table class="table" id="sizeTable">
              <thead><tr><th>Size</th><th>Count</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="refreshBtn">Refresh Analytics</button>
          <span class="muted" id="analyticsStatus"></span>
        </div>
      </section>
    </div>
  </main>

  <footer>
    © LUTHER CLOTHING LIMITED<br>EST.2025
  </footer>

  <script>
    // ---------- CONFIG ----------
    const ORDER_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzJK5w3BPvZhkmNRC75_oskgCjDdP7I0Xup5G7P0iRhRw--VeLpJnAJPc6vdSBC3B--Rw/exec";

    // Use exactly your product image paths
    const PRODUCTS = [
      { name: "Onyx Black Hoodie", image: "assets/products/essentials/onyx-hoodie/front.png", sizes: ["S","M","L","XL"] },
      { name: "Root Brown Hoodie", image: "assets/products/essentials/brown-hoodie/front.png", sizes: ["S","M","L","XL"] },
      { name: "Onyx Black Tee",    image: "assets/products/essentials/onyx-tee/front.png", sizes: ["S","M","L","XL"] },
      { name: "Bone Tee",          image: "assets/products/essentials/bone-tee/front.png", sizes: ["S","M","L","XL"] },
    ];

    // ---------- HEADER THEME TOGGLE ----------
    const header = document.getElementById('header');
    const headerLogo = document.getElementById('headerLogo');
    const heroSection = document.getElementById('hero');

    function setHeaderState(isTransparent) {
      if (isTransparent) {
        header.style.backgroundColor = 'transparent';
        headerLogo.src = 'assets/logos/lutherTextWhite.png';
        document.querySelectorAll('header a').forEach(a => a.style.color = 'white');
        document.querySelectorAll('.hamburger span').forEach(span => span.style.background = 'white');
      } else {
        header.style.backgroundColor = 'white';
        headerLogo.src = 'assets/logos/lutherTextBlack.png';
        document.querySelectorAll('header a').forEach(a => a.style.color = 'black');
        document.querySelectorAll('.hamburger span').forEach(span => span.style.background = 'black');
      }
    }

    const observer = new IntersectionObserver(([entry]) => {
      setHeaderState(entry.isIntersecting);
    }, { threshold: 0.5 });
    observer.observe(heroSection);

    headerLogo.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    const ordersBtn = document.getElementById('ordersBtn');
    const analyticsBtn = document.getElementById('analyticsBtn');
    ordersBtn && ordersBtn.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('ordersSection').scrollIntoView({ behavior: 'smooth' });
    });
    analyticsBtn && analyticsBtn.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('analyticsSection').scrollIntoView({ behavior: 'smooth' });
    });

    // Mobile menu
    const hamburger = document.getElementById('hamburger');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileOrdersBtn = document.getElementById('mobileOrdersBtn');
    const mobileAnalyticsBtn = document.getElementById('mobileAnalyticsBtn');

    function isHeroMostlyVisible() {
      const heroRect = heroSection.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const intersectionHeight = Math.min(heroRect.bottom, viewportHeight) - Math.max(heroRect.top, 0);
      const intersectionRatio = intersectionHeight / heroRect.height;
      return intersectionRatio >= 0.5;
    }

    function openMobileMenu() {
      hamburger.classList.add('active');
      hamburger.setAttribute('aria-expanded', 'true');
      mobileMenu.style.display = 'flex';
      document.body.classList.add('menu-open');
      requestAnimationFrame(() => mobileMenu.classList.add('show'));
      setHeaderState(isHeroMostlyVisible());
    }

    function closeMobileMenu() {
      hamburger.classList.remove('active');
      hamburger.setAttribute('aria-expanded', 'false');
      mobileMenu.classList.remove('show');
      document.body.classList.remove('menu-open');
      setTimeout(() => { mobileMenu.style.display = 'none'; }, 400);
      setHeaderState(isHeroMostlyVisible());
    }

    hamburger.addEventListener('click', () => {
      if (hamburger.classList.contains('active')) closeMobileMenu();
      else openMobileMenu();
    });

    mobileOrdersBtn && mobileOrdersBtn.addEventListener('click', (e) => {
      e.preventDefault(); closeMobileMenu();
      document.getElementById('ordersSection').scrollIntoView({ behavior: 'smooth' });
    });
    mobileAnalyticsBtn && mobileAnalyticsBtn.addEventListener('click', (e) => {
      e.preventDefault(); closeMobileMenu();
      document.getElementById('analyticsSection').scrollIntoView({ behavior: 'smooth' });
    });

    document.getElementById('leftLink').addEventListener('click', (e) => {
      e.preventDefault();
      history.back();
    });

    // ---------- ORDER FORM ----------
    const productsEl = document.getElementById('products');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    const clearProductsBtn = document.getElementById('clearProductsBtn');

function clearAllSelections() {
  productsEl.querySelectorAll(".product-tile").forEach(tile => {
    tile.classList.remove("selected");
    tile.querySelectorAll(".size-btn").forEach(btn => {
      btn.dataset.count = "0";
      btn.classList.remove("active");
      const c = btn.querySelector(".count");
      if (c) c.textContent = "0";
    });
    const idx = Number(tile.dataset.idx);
    syncTileState(idx);
  });
}

clearProductsBtn && clearProductsBtn.addEventListener("click", () => {
  clearAllSelections();
  statusEl.textContent = "Cleared.";
});


    function renderProducts() {
  productsEl.innerHTML = "";

  PRODUCTS.forEach((p, idx) => {
    const tile = document.createElement("div");
    tile.className = "product-tile";
    tile.dataset.idx = String(idx);

    tile.innerHTML = `
      <div class="img" role="button" aria-label="Toggle ${escapeHtml(p.name)}">
        <img src="${p.image}" alt="${escapeHtml(p.name)}" loading="lazy" />
        <div class="label">
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="state" id="state_${idx}">Not selected</div>
        </div>
      </div>

      <div class="size-wrap">
        <div class="size-row" id="sizes_${idx}">
          ${p.sizes.map(sz => `
            <button
              type="button"
              class="size-btn"
              data-size="${escapeHtml(sz)}"
              data-count="0"
              aria-label="${escapeHtml(p.name)} size ${escapeHtml(sz)}"
            >
              <span class="labelTxt">${escapeHtml(sz)}</span>
              <span class="count">0</span>
            </button>
          `).join("")}
        </div>
        <div class="size-hint">Click to add • Shift+Click to remove</div>
      </div>
    `;

    // Clicking image toggles product on/off (off clears counts)
    tile.querySelector(".img").addEventListener("click", () => {
      const isSelected = tile.classList.toggle("selected");

      if (!isSelected) {
        tile.querySelectorAll(".size-btn").forEach(btn => {
          btn.dataset.count = "0";
          btn.classList.remove("active");
          btn.querySelector(".count").textContent = "0";
        });
      }
      syncTileState(idx);
    });

    // Size buttons = quantity control
    tile.querySelectorAll(".size-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();

        let count = Number(btn.dataset.count || "0");

        // Shift+click decreases
        if (e.shiftKey) count = Math.max(0, count - 1);
        else count = count + 1;

        btn.dataset.count = String(count);
        btn.querySelector(".count").textContent = String(count);

        if (count > 0) btn.classList.add("active");
        else btn.classList.remove("active");

        // If any size count > 0, mark tile selected; otherwise unselect
        const total = Array.from(tile.querySelectorAll(".size-btn"))
          .reduce((sum, b) => sum + Number(b.dataset.count || "0"), 0);

        if (total > 0) tile.classList.add("selected");
        else tile.classList.remove("selected");

        syncTileState(idx);
      });
    });

    productsEl.appendChild(tile);
    syncTileState(idx);
  });
}

function syncTileState(idx) {
  const tile = productsEl.querySelector(`.product-tile[data-idx="${idx}"]`);
  const stateEl = document.getElementById(`state_${idx}`);
  const selected = tile.classList.contains("selected");

  const btns = Array.from(tile.querySelectorAll(".size-btn"));
  const picked = btns
    .map(b => ({ size: b.dataset.size, count: Number(b.dataset.count || "0") }))
    .filter(x => x.count > 0);

  const totalQty = picked.reduce((sum, x) => sum + x.count, 0);

  if (!selected || totalQty === 0) {
    stateEl.textContent = "Not selected";
  } else {
    // Example: "Qty 3" or "S×2, M×1"
    const short = picked.map(x => `${x.size}×${x.count}`).join(", ");
    stateEl.textContent = `Qty ${totalQty} • ${short}`;
  }
}

function getSelectedItems() {
  const items = [];

  productsEl.querySelectorAll(".product-tile").forEach(tile => {
    const idx = Number(tile.dataset.idx);

    const sizes = Array.from(tile.querySelectorAll(".size-btn"))
      .map(b => ({ size: b.dataset.size, qty: Number(b.dataset.count || "0") }))
      .filter(x => x.qty > 0);

    const totalQty = sizes.reduce((sum, s) => sum + s.qty, 0);
    if (totalQty === 0) return;

    items.push({
      product: PRODUCTS[idx].name,
      totalQty,
      sizes // example: [{size:"S", qty:2}, {size:"M", qty:1}]
    });
  });

  return items;
}

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[s]));
    }

    async function postFormUrlEncoded(payloadObj) {
  const body = new URLSearchParams();
  Object.entries(payloadObj).forEach(([k, v]) => body.append(k, typeof v === 'string' ? v : JSON.stringify(v)));

  const res = await fetch(ORDER_WEB_APP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body
  });

  const text = await res.text(); // read raw text first
  try {
    return JSON.parse(text);
  } catch (e) {
    console.error("Non-JSON response from Apps Script:", text);
    throw new Error("Apps Script returned non-JSON (check deployment access/URL).");
  }
}


    submitBtn.addEventListener('click', async () => {
      statusEl.textContent = "";
      submitBtn.disabled = true;

      const items = getSelectedItems();
      if (!items.length) {
        statusEl.textContent = "Select at least one product.";
        submitBtn.disabled = false;
        return;
      }

      const hasEmptySizes = items.some(i => !i.sizes || i.sizes.length === 0 || i.totalQty <= 0);
      if (hasEmptySizes) {
        statusEl.textContent = "Pick at least one size for each selected product.";
        submitBtn.disabled = false;
        return;
      }

      try {
        const payload = {
          action: "createOrder",
          firstName: document.getElementById("firstName").value || "",
          lastName: document.getElementById("lastName").value || "",
          instagram: document.getElementById("instagram").value || "",
          email: document.getElementById("email").value || "",
          phone: document.getElementById("phone").value || "",
          notes: document.getElementById("notes").value || "",
          items
        };

        const out = await postFormUrlEncoded(payload);

        if (out.status === "success" || out.ok === true) {
          statusEl.textContent = "Saved.";
          await refreshAnalytics();
       } else {
  statusEl.textContent = "Error: " + (out.message || "Saving failed.");
  console.error(out);
}
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error saving order.";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ---------- ANALYTICS ----------
    const refreshBtn = document.getElementById('refreshBtn');
    const analyticsStatus = document.getElementById('analyticsStatus');

    function setTableRows(tableId, rows) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join("");
    }

    async function refreshAnalytics() {
      analyticsStatus.textContent = "Refreshing...";
      try {
        const out = await postFormUrlEncoded({ action: "getAnalytics" });

        const data = (out.ok ? out : null) || out;
        if (!(data && (data.ok || out.status === "success"))) {
          analyticsStatus.textContent = "Analytics unavailable.";
          return;
        }

        const totals = data.totals || {};
        document.getElementById('totalOrders').textContent = totals.totalOrders ?? 0;
        document.getElementById('totalItems').textContent = totals.totalItems ?? 0;

        const prod = data.productCounts || {};
        const sizes = data.sizeCounts || {};

        const prodRows = Object.entries(prod).sort((a,b)=>b[1]-a[1]);
        const sizeRows = Object.entries(sizes).sort((a,b)=>b[1]-a[1]);

        setTableRows("productTable", prodRows);
        setTableRows("sizeTable", sizeRows);

        await refreshOrdersList();

        analyticsStatus.textContent = "Updated.";
      } catch (e) {
        console.error(e);
        analyticsStatus.textContent = "Error loading analytics.";
      }
    }

    refreshBtn.addEventListener('click', refreshAnalytics);

    const ordersListStatus = document.getElementById("ordersListStatus");

function escapeHtmlText(s){
  return String(s || "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function fmtDate(dStr){
  // dStr may come as ISO string or Date text; keep it simple:
  try {
    const d = new Date(dStr);
    if (isNaN(d.getTime())) return String(dStr || "");
    return d.toLocaleString();
  } catch {
    return String(dStr || "");
  }
}

async function refreshOrdersList() {
  ordersListStatus.textContent = "Loading orders...";
  try {
    const out = await postFormUrlEncoded({ action: "listOrders" });

    if (!(out && out.ok)) {
      ordersListStatus.textContent = "Could not load orders.";
      console.error(out);
      return;
    }

    const rows = out.orders || [];
    const tbody = document.querySelector("#ordersTable tbody");

    if (!rows.length) {
      tbody.innerHTML = "";
      ordersListStatus.textContent = "No orders yet.";
      return;
    }

    tbody.innerHTML = rows.map(o => {
      const orderId = escapeHtmlText(o.orderId);
      const date = escapeHtmlText(fmtDate(o.createdAt));
      const name = escapeHtmlText(o.name);
      const items = escapeHtmlText(o.itemsSummary);

      return `
        <tr>
          <td>${date}</td>
          <td>${name}</td>
          <td>${items}</td>
          <td style="text-align:right;">
            <button class="btn small" data-del="${orderId}" type="button">Remove</button>
          </td>
        </tr>
      `;
    }).join("");

    // bind delete buttons
    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const orderId = btn.getAttribute("data-del");
        if (!orderId) return;

        // simple confirm
        const ok = confirm("Remove this order? This cannot be undone.");
        if (!ok) return;

        btn.disabled = true;
        ordersListStatus.textContent = "Removing...";

        try {
          const delOut = await postFormUrlEncoded({ action: "deleteOrder", orderId });

          if (delOut && delOut.ok) {
            ordersListStatus.textContent = "Removed.";
            await refreshAnalytics();
            await refreshOrdersList();
          } else {
            ordersListStatus.textContent = "Error removing order.";
            console.error(delOut);
          }
        } catch (e) {
          console.error(e);
          ordersListStatus.textContent = "Error removing order.";
        } finally {
          btn.disabled = false;
        }
      });
    });

    ordersListStatus.textContent = `Showing ${rows.length} orders.`;
  } catch (e) {
    console.error(e);
    ordersListStatus.textContent = "Error loading orders.";
  }
}


    // init
   renderProducts();
refreshAnalytics();
refreshOrdersList();

  </script>
</body>
</html>
